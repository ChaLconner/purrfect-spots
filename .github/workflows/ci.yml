# ==============================================================================
# Purrfect Spots - CI/CD Pipeline (Production)
# ==============================================================================
# Comprehensive CI/CD workflow for the Purrfect Spots application
# Includes linting, testing, security scanning, and build verification
# ==============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, dev]
    paths-ignore:
      - "docs/**"
      - "**.md"
      - ".vscode/**"
      - ".agent/**"
      - ".gemini/**"
  pull_request:
    branches: [main, develop, dev]
    paths-ignore:
      - "docs/**"
      - "**.md"
      - ".vscode/**"
      - ".agent/**"
      - ".gemini/**"
  workflow_dispatch:
    inputs:
      force_full_run:
        description: "Force full pipeline run (ignore change detection)"
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"
  CACHE_VERSION: v1

permissions:
  contents: read
  pull-requests: read
  security-events: write

# ==============================================================================
# JOBS DEFINITION
# ==============================================================================
jobs:
  # ----------------------------------------------------------------------------
  # STAGE 1: INITIALIZATION & DETECTION
  # ----------------------------------------------------------------------------
  changes:
    name: "Initialize: Detect Changes"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      docker: ${{ steps.filter.outputs.docker }}
      ci: ${{ steps.filter.outputs.ci }}
      run_backend: ${{ inputs.force_full_run == true || steps.filter.outputs.backend == 'true' || steps.filter.outputs.ci == 'true' || steps.filter.outputs.api_spec == 'true' }}
      run_frontend: ${{ inputs.force_full_run == true || steps.filter.outputs.frontend == 'true' || steps.filter.outputs.ci == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4

      - name: Filter paths
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'api-client/**'
            frontend:
              - 'frontend/**'
            docker:
              - '**/Dockerfile'
              - 'docker-compose.yml'
            ci:
              - '.github/workflows/**'
              - '.github/actions/**'
            api_spec:
              - 'docs/openapi-baseline.json'

  # ----------------------------------------------------------------------------
  # STAGE 2: BACKEND VERIFICATION
  # ----------------------------------------------------------------------------
  backend-lint:
    name: "Backend: Lint & Format"
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.run_backend == 'true'
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Setup Backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          install-deps: "true"
      - name: Run Ruff
        run: |
          cd backend
          ruff check . --output-format=github
          ruff format --check .

  backend-typecheck:
    name: "Backend: Type Check"
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.run_backend == 'true'
    continue-on-error: true
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Setup Backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Run MyPy
        run: |
          cd backend
          mypy . --config-file pyproject.toml || echo "::warning::Type checking found issues (non-blocking)"

  backend-test:
    name: "Backend: Unit Tests"
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.run_backend == 'true'
    timeout-minutes: 20
    services:
      redis:
        image: redis:7-alpine
        ports: ["6379:6379"]
        options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Setup Backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Run tests with coverage
        env:
          ENVIRONMENT: test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'http://localhost:54321' }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          cd backend
          pytest --cov=. --cov-report=xml:coverage.xml --cov-report=term-missing --cov-fail-under=60 -v --tb=short
      - name: Upload Report
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4
        if: always()
        with:
          file: backend/coverage.xml
          flags: backend
        continue-on-error: true

  api-contract:
    name: "Backend: API Contract"
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.run_backend == 'true'
    continue-on-error: true
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Setup Backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Check Contract
        env:
          ENVIRONMENT: test
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'http://localhost:54321' }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY || 'dummy-anon-key' }}
        run: |
          cd backend
          if [ -f "../docs/openapi-baseline.json" ]; then
            python scripts/check_api_breaking_changes.py --baseline ../docs/openapi-baseline.json
          fi
          python scripts/export_openapi.py --output ../docs/openapi-current.json
      - name: Upload Spec
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: openapi-specs
          path: docs/openapi-*.json

  backend-verify:
    name: "Backend: Build Verify"
    runs-on: ubuntu-latest
    needs: [backend-lint, backend-test]
    if: always() && (needs.backend-lint.result == 'success' || needs.backend-lint.result == 'skipped') && (needs.backend-test.result == 'success' || needs.backend-test.result == 'skipped')
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Setup Backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          install-deps: "true"
      - name: Verify
        env:
          ENVIRONMENT: test
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'http://localhost:54321' }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY || 'dummy-anon-key' }}
        run: |
          cd backend
          python -m compileall -q .
          python -c "from main import app; print('✅ FastAPI app imports successfully')"

  # ----------------------------------------------------------------------------
  # STAGE 3: FRONTEND VERIFICATION
  # ----------------------------------------------------------------------------
  frontend-check:
    name: "Frontend: Lint & Typecheck"
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.run_frontend == 'true'
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Setup Frontend
        uses: ./.github/actions/setup-frontend
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Lint & Typecheck
        run: |
          npm run type-check -w frontend
          npm run lint:check -w frontend

  frontend-test:
    name: "Frontend: Unit Tests"
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.run_frontend == 'true'
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Setup Frontend
        uses: ./.github/actions/setup-frontend
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Run Vitest
        run: npm run test:coverage -w frontend
      - name: Upload Coverage
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: frontend-coverage-report
          path: frontend/coverage

  frontend-build:
    name: "Frontend: Build Bundle"
    runs-on: ubuntu-latest
    needs: [frontend-check, frontend-test]
    if: always() && (needs.frontend-check.result == 'success' || needs.frontend-check.result == 'skipped') && (needs.frontend-test.result == 'success' || needs.frontend-test.result == 'skipped')
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Setup Frontend
        uses: ./.github/actions/setup-frontend
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Build
        run: npm run build -w frontend
      - name: Upload Artifact
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: frontend-build
          path: frontend/dist

  # ----------------------------------------------------------------------------
  # STAGE 4: SECURITY SCANS
  # ----------------------------------------------------------------------------
  security-vuln:
    name: "Security: Trivy Scan"
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@e368e328979b113139d6f9068e03accaed98a518 # v0.34.1
        with:
          scan-type: "fs"
          severity: "CRITICAL,HIGH"
          format: "sarif"
          output: "trivy-results.sarif"
          trivy-config: "trivy.yaml"
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

  security-secrets:
    name: "Security: Secret Scan"
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
        with:
          fetch-depth: 0
      - name: Trufflehog
        uses: trufflesecurity/trufflehog@7c0734f987ad0bb30ee8da210773b800ee2016d3 # v3.93.4
        with:
          extra_args: --only-verified

  security-sast:
    name: "Security: SAST Semgrep"
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 20
    continue-on-error: true
    container:
      image: semgrep/semgrep:latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Semgrep
        run: |
          semgrep scan --config "p/default" --config "p/security-audit" --sarif --output semgrep.sarif . || true
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3
        if: always() && hashFiles('semgrep.sarif') != ''
        with:
          sarif_file: semgrep.sarif

  security-deps:
    name: "Security: Dep Review"
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'pull_request'
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Dependency Review
        uses: actions/dependency-review-action@dea54b434272cc45b0e9ff17d5f0da4d8676f07d # v4.8.2
        with:
          fail-on-severity: critical

  # ----------------------------------------------------------------------------
  # STAGE 5: FINAL GATES
  # ----------------------------------------------------------------------------
  quality-gate:
    name: "Final: Quality Gate"
    runs-on: ubuntu-latest
    needs: [backend-verify, frontend-build, security-vuln, security-secrets]
    if: always()
    steps:
      - name: Check Status
        run: |
          echo "Verifying quality gate..."
          if [[ "${{ needs.backend-verify.result }}" == "failure" || "${{ needs.frontend-build.result }}" == "failure" || "${{ needs.security-vuln.result }}" == "failure" || "${{ needs.security-secrets.result }}" == "failure" ]]; then
            echo "::error::Core quality checks failed. Please review the workflow logs."
            exit 1
          fi
          echo "✅ All core checks passed or were skipped."

  summary:
    name: "Final: Summary"
    runs-on: ubuntu-latest
    needs:
      [changes, quality-gate, backend-typecheck, api-contract, security-sast]
    if: always()
    steps:
      - name: Build Summary Report
        run: |
          echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Initialize | ${{ needs.changes.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gate | ${{ needs.quality-gate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security SAST | ${{ needs.security-sast.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Contract | ${{ needs.api-contract.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Types | ${{ needs.backend-typecheck.result }} |" >> $GITHUB_STEP_SUMMARY
