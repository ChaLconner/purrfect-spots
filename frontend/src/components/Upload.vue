<template>
  <div class="max-w-2xl mx-auto mt-8 p-8 bg-white rounded-xl shadow-md">
    <h2 class="text-center mb-8 text-gray-700 text-2xl font-semibold">
      Upload Your Cat's Photo
    </h2>

    <!-- Upload Form -->
    <form @submit.prevent="handleSubmit" v-if="!isUploading">
      <div class="mb-6">
        <label for="locationName" class="block mb-2 font-medium text-gray-700"
          >Location Name</label
        >
        <input
          id="locationName"
          v-model="locationName"
          type="text"
          placeholder="Enter location name"
          required
          class="w-full px-3 py-3 border border-gray-300 rounded-lg text-base transition-colors focus:outline-none focus:border-emerald-500 focus:ring-3 focus:ring-emerald-100"
        />
      </div>
      <div class="mb-6">
        <label for="description" class="block mb-2 font-medium text-gray-700"
          >Description</label
        >
        <textarea
          id="description"
          v-model="description"
          placeholder="Enter description"
          rows="3"
          class="w-full px-3 py-3 border border-gray-300 rounded-lg text-base transition-colors resize-none focus:outline-none focus:border-emerald-500 focus:ring-3 focus:ring-emerald-100"
        ></textarea>
      </div>

      <!-- GPS Coordinates -->
      <div class="mb-6">
        <label class="block mb-2 font-medium text-gray-700"
          >Select Location on Map</label
        >
        <div class="mb-3">
          <button
            type="button"
            @click="getCurrentLocation"
            :disabled="gettingLocation"
            class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {{
              gettingLocation ? "Getting Location..." : "Use Current Location"
            }}
          </button>
        </div>

        <l-map
          style="
            height: 250px;
            width: 100%;
            border-radius: 0.75rem;
            overflow: hidden;
          "
          :zoom="mapZoom"
          :center="mapCenter"
          @update:center="onMapMove"
          @click="onMapClick"
        >
          <l-tile-layer :url="tileLayerUrl" :attribution="tileLayerAttr" />
          <l-marker
            :lat-lng="markerLatLng"
            :draggable="true"
            @update:lat-lng="onMarkerDrag"
            @moveend="onMarkerDrag"
          />
        </l-map>

        <p class="text-sm text-gray-600 mt-2">
          üí° Click on the map or drag the marker to select a location.
        </p>
      </div>

      <!-- File Upload Area -->
      <div
        class="border-2 border-dashed border-gray-300 rounded-xl p-12 text-center cursor-pointer transition-all mb-6 hover:border-emerald-500 hover:bg-green-50"
        @dragover.prevent
        @drop.prevent="handleDrop"
        @click="triggerFileInput"
      >
        <input
          ref="fileInput"
          type="file"
          accept="image/*"
          @change="handleFileChange"
          class="hidden"
        />
        <div v-if="previewUrl">
          <img
            :src="previewUrl"
            alt="Preview"
            class="max-w-full max-h-72 rounded-lg shadow-md mx-auto"
          />
          <p class="mt-4 text-gray-600">{{ file?.name }}</p>
          
          <!-- Cat Detection Loading -->
          <div v-if="isDetectingCats" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center justify-center">
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mr-3"></div>
              <span class="text-blue-700">üîç Detecting cats in your photo...</span>
            </div>
          </div>       
        </div>
        <div v-else>
          <p class="mb-4 text-gray-500 text-lg">
            Drag and drop or click to upload
          </p>
          <button
            type="button"
            class="bg-emerald-500 text-white border-none px-4 py-2 rounded-md cursor-pointer transition-colors hover:bg-emerald-600"
          >
            Browse Files
          </button>
        </div>
      </div>

      <!-- Submit Button -->
      <div v-if="!authStore.isAuthenticated" class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg mb-4">
        <div class="flex items-center">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          <span>You must be logged in to upload photos.</span>
        </div>
      </div>
      <div
        @click="!authStore.isAuthenticated ? router.push('/login') : null"
        style="cursor:pointer;display:block;width:100%"
      >
        <button
          type="submit"
          :disabled="!authStore.isAuthenticated || !file || isDetectingCats || (catDetectionResult && !catDetectionResult.has_cats)"
          class="w-full bg-gradient-to-r from-emerald-500 via-teal-500 to-cyan-500 text-white border-none py-3.5 px-6 rounded-lg text-lg font-semibold shadow-md cursor-pointer transition-all duration-200 hover:from-emerald-600 hover:via-teal-600 hover:to-cyan-600 hover:shadow-lg disabled:opacity-50"
          style="pointer-events:none"
        >
          <span v-if="!authStore.isAuthenticated">Login to Upload</span>
          <span v-else-if="isDetectingCats">üîç Detecting Cats...</span>
          <span v-else-if="catDetectionResult && !catDetectionResult.has_cats">‚ùå No Cat Detected</span>
          <span v-else>Upload Cat Photo</span>
        </button>
      </div>
    </form>

    <!-- Upload Progress -->
    <div v-if="isUploading" class="text-center py-8">
      <div class="flex flex-col items-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-orange-500 mb-4"></div>
        <h3 class="text-lg font-semibold text-gray-700 mb-2">üê± Uploading your cat photo...</h3>
        <p class="text-sm text-gray-500">Please wait a moment while we process your image.</p>
      </div>
    </div>

    <!-- Success Message -->
    <div v-if="uploadSuccess" class="text-center">
      <div class="mb-4">
        <svg
          class="h-16 w-16 text-green-500 mx-auto"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7"
          ></path>
        </svg>
      </div>
      <p class="text-green-600 text-lg mb-4">Photo uploaded successfully!</p>
    </div>

    <!-- Error Message -->
    <div
      v-if="error"
      class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6"
    >
      <p class="font-bold">Error:</p>
      <p>{{ error }}</p>
    </div>
  </div>
</template>

<script setup>
import { ref, watch, onMounted, onErrorCaptured } from "vue";
import { useRouter } from "vue-router";
import { LMap, LTileLayer, LMarker } from "@vue-leaflet/vue-leaflet";
import "leaflet/dist/leaflet.css";
import { useUploadCat } from "../composables/useUploadCat";
import { authStore, isUserReady, getAuthHeader } from "../store/auth";
import { catDetectionService } from "../services/catDetectionService";
import { createApiUrl } from "../config/api";

const router = useRouter();

onMounted(() => {
  // Initialize any necessary data
});

const locationName = ref("");
const description = ref("");
const latitude = ref("18.7883");
const longitude = ref("98.9853");
const file = ref(null);
const previewUrl = ref(null);
const fileInput = ref(null);
const uploadSuccess = ref(false);
const gettingLocation = ref(false);
const locationSuccess = ref(false);
const classificationLabel = ref(null);
const classificationConfidence = ref(null);
const isDetectingCats = ref(false);
const catDetectionResult = ref(null);
const showDetectionResults = ref(false);

const { uploadCat, isUploading, error } = useUploadCat();

onErrorCaptured((err) => {
  if (err.message && err.message.includes("message channel closed")) {
    console.warn("Browser extension conflict detected, ignoring:", err.message);
    return false;
  }
  return true;
});

onMounted(() => {
  window.addEventListener("unhandledrejection", (event) => {
    if (
      event.reason &&
      event.reason.message &&
      event.reason.message.includes("message channel closed")
    ) {
      console.warn("Prevented extension error:", event.reason.message);
      event.preventDefault();
    }
  });
});

const mapZoom = ref(13);
const mapCenter = ref([18.7883, 98.9853]);
const markerLatLng = ref([18.7883, 98.9853]);
const tileLayerUrl = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
const tileLayerAttr =
  '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

watch([latitude, longitude], ([lat, lng]) => {
  if (lat && lng) {
    markerLatLng.value = [parseFloat(lat), parseFloat(lng)];
    mapCenter.value = [parseFloat(lat), parseFloat(lng)];
  }
});

function onMarkerDrag(newLatLng) {
  let lat, lng;

  if (Array.isArray(newLatLng)) {
    lat = newLatLng[0];
    lng = newLatLng[1];
  } else if (newLatLng && typeof newLatLng === "object") {
    lat = newLatLng.lat || newLatLng.latitude;
    lng = newLatLng.lng || newLatLng.longitude;
  } else {
    console.error("Unexpected newLatLng format:", newLatLng);
    return;
  }

  if (lat !== undefined && lng !== undefined) {
    markerLatLng.value = [lat, lng];
    latitude.value = lat.toFixed(6);
    longitude.value = lng.toFixed(6);
    locationSuccess.value = true;
    setTimeout(() => (locationSuccess.value = false), 2000);
  }
}

function onMapMove(newCenter) {
  mapCenter.value = newCenter;
}

function onMapClick(event) {
  let lat, lng;

  if (event && event.latlng) {
    lat = event.latlng.lat;
    lng = event.latlng.lng;
  } else if (event && event.lat !== undefined && event.lng !== undefined) {
    lat = event.lat;
    lng = event.lng;
  } else {
    console.error("Unexpected event format:", event);
    return;
  }

  if (lat !== undefined && lng !== undefined) {
    latitude.value = lat.toFixed(6);
    longitude.value = lng.toFixed(6);
    markerLatLng.value = [lat, lng];
    locationSuccess.value = true;
    setTimeout(() => (locationSuccess.value = false), 1000);
  }
}

function getCurrentLocation() {
  gettingLocation.value = true;
  error.value = null;
  locationSuccess.value = false;

  if (!navigator.geolocation) {
    error.value = "Geolocation is not supported by your browser.";
    gettingLocation.value = false;
    return;
  }

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° options ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
  const geoOptions = {
    enableHighAccuracy: true, // ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
    timeout: 15000,           // ‡∏£‡∏≠‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    maximumAge: 0             // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ cache
  };

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      latitude.value = lat.toFixed(6);
      longitude.value = lng.toFixed(6);
      markerLatLng.value = [lat, lng];
      mapCenter.value = [lat, lng];

      locationSuccess.value = true;
      gettingLocation.value = false;

      setTimeout(() => (locationSuccess.value = false), 2000);
    },
    (err) => {
      switch (err.code) {
        case err.PERMISSION_DENIED:
          error.value = "Permission denied. Please allow location access.";
          break;
        case err.POSITION_UNAVAILABLE:
          error.value = "Location information is unavailable.";
          break;
        case err.TIMEOUT:
          error.value = "The request to get user location timed out.";
          break;
        default:
          error.value = "An unknown error occurred while getting location.";
          break;
      }
      gettingLocation.value = false;
    },
    geoOptions // <-- ‡∏™‡πà‡∏á options ‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
  );
}

function triggerFileInput() {
  fileInput.value.click();
}

function handleFileChange(e) {
  const selected = e.target.files[0];
  if (selected && selected.type.startsWith("image/")) {
    file.value = selected;
    previewUrl.value = URL.createObjectURL(selected);
    error.value = null;
    detectCatsInImage(selected);
  }
}

function handleDrop(e) {
  const dropped = e.dataTransfer.files[0];
  if (dropped && dropped.type.startsWith("image/")) {
    file.value = dropped;
    previewUrl.value = URL.createObjectURL(dropped);
    error.value = null;
    detectCatsInImage(dropped);
  }
}

async function detectCatsInImage(imageFile) {
  if (!imageFile) return;
  
  isDetectingCats.value = true;
  catDetectionResult.value = null;
  showDetectionResults.value = false;
  error.value = null;
  
  try {
    const result = await catDetectionService.testDetectCats(imageFile);
    
    catDetectionResult.value = result;
    showDetectionResults.value = true;
    
    if (!result.has_cats || result.cat_count === 0) {
      error.value = `Please upload a photo that contains a cat.`;
      file.value = null;
      previewUrl.value = null;
      showDetectionResults.value = false;
    }
    
  } catch (error) {
    console.error('‚ùå Cat detection failed:', error);
    error.value = `‚ö†Ô∏è We couldn't check for cats: ${error.message}. You can still upload your photo.`;
    catDetectionResult.value = {
      has_cats: true,
      cat_count: 1,
      confidence: 50,
      note: "Detection unavailable - please check manually"
    };
    showDetectionResults.value = true;
  } finally {
    isDetectingCats.value = false;
  }
}

async function handleSubmit() {
  if (!authStore.isAuthenticated || !authStore.user) {
    sessionStorage.setItem('redirectAfterAuth', '/upload');
    router.push('/login');
    return;
  }

  if (!file.value) {
    error.value = "Please select a file to upload.";
    return;
  }
  
  if (!catDetectionResult.value) {
    error.value = "Please wait for the cat detection to finish.";
    return;
  }
  
  if (!catDetectionResult.value.has_cats || catDetectionResult.value.cat_count === 0) {
    error.value = "Sorry, we couldn't find a cat in your photo. Please choose another photo with a cat.";
    return;
  }
  
  if (
    !latitude.value ||
    !longitude.value ||
    latitude.value === "" ||
    longitude.value === ""
  ) {
    error.value =
      "Please select a location on the map by clicking, dragging the marker, or using your current location.";
    return;
  }
  if (!locationName.value.trim()) {
    error.value = "Please enter a location name.";
    return;
  }

  isUploading.value = true;
  error.value = null;
  uploadSuccess.value = false;
  
  const formData = new FormData();
  formData.append("file", file.value);
  formData.append("lat", latitude.value);
  formData.append("lng", longitude.value);
  formData.append("description", description.value.trim() || "");
  formData.append("location_name", locationName.value.trim());
  
  formData.append("cat_detection_data", JSON.stringify({
    has_cats: catDetectionResult.value.has_cats,
    cat_count: catDetectionResult.value.cat_count,
    confidence: catDetectionResult.value.confidence,
    suitable_for_cat_spot: catDetectionResult.value.suitable_for_cat_spot,
    cats_detected: catDetectionResult.value.cats_detected || [],
    detection_timestamp: new Date().toISOString()
  }));
  
  try {
    const res = await fetch(createApiUrl('/upload/cat'), {
      method: "POST",
      headers: {
      ...getAuthHeader()
      },
      body: formData
    });
    let data = null;
    const text = await res.text();
    try {
      data = text ? JSON.parse(text) : {};
    } catch (e) {
      data = {};
    }
    if (res.ok) {
      uploadSuccess.value = true;
      if (data && Array.isArray(data.classification)) {
        const catLabel = data.classification.find(
          (item) => typeof item === "string" && item.toLowerCase().includes("cat")
        );
        if (catLabel) {
          classificationLabel.value = catLabel;
          classificationConfidence.value = null;
        } else {
          classificationLabel.value = "No cat detected in this image";
          classificationConfidence.value = null;
        }
      }
      setTimeout(() => {
        window.location.reload();
      }, 500);
      setTimeout(() => {
        window.location.reload();
      }, 500);
    } else {
      if (res.status === 401) {
        sessionStorage.setItem('redirectAfterAuth', '/upload');
        router.push('/login');
        return;
      }
      error.value = (data && data.detail) || "Upload failed.";
    }
  } catch (err) {
    error.value = "An error occurred while uploading the photo.";
    console.error("Upload error:", err);
  } finally {
    isUploading.value = false;
  }
}

function resetForm() {
  locationName.value = "";
  description.value = "";
  latitude.value = "18.7883";
  longitude.value = "98.9853";
  file.value = null;
  previewUrl.value = null;
  uploadSuccess.value = false;
  gettingLocation.value = false;
  locationSuccess.value = false;
  classificationLabel.value = null;
  classificationConfidence.value = null;
}
</script>
